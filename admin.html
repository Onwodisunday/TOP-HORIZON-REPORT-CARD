<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Top Horizon</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-num {
            font-size: 32px;
            font-weight: bold;
            color: var(--theme-orange);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--theme-dark);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <div class="brand">
                <i data-lucide="shield" class="brand-icon"></i>
                <span class="brand-name">Top Horizon Admin</span>
            </div>
            <div class="nav-actions">
                <a href="index.html" class="btn btn-secondary" style="text-decoration:none;">Website</a>
                <button class="btn btn-danger" onclick="logoutAdmin()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="admin-container">

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-num" id="stat-teachers">0</div>
                <div>Registered Teachers</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="stat-reports">0</div>
                <div>Total Reports</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="stat-storage">0%</div>
                <div>Storage Usage</div>
            </div>
        </div>

        <!-- Teachers -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="users"></i> Teacher Management
            </h2>
            <p style="color:#666; margin-bottom:15px;">List of all registered classes and teachers.</p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>PIN</th>
                        <th>Subjects</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teachers-table">
                    <!-- JS -->
                </tbody>
            </table>
        </div>

        <!-- System Data -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="database"></i> System Data
            </h2>
            <div class="card" style="padding:20px;">
                <p>Backup individual data or the entire system database.</p>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-primary" onclick="backupSystem()">Download System Backup (JSON)</button>
                    <input type="file" id="restore-file" style="display:none" onchange="restoreSystem(this)">
                    <button class="btn btn-secondary" onclick="document.getElementById('restore-file').click()">Restore
                        from Backup</button>
                    <button class="btn btn-danger" onclick="clearSystem()">Factory Reset</button>
                </div>
            </div>
        </div>

        <!-- Admin Access Management -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="user-plus"></i> Admin Access
            </h2>
            <div class="card"
                style="padding:20px; background:white; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <p>Invite trusted staff members to become administrators.</p>
                <div style="display:flex; gap:10px; margin-top:15px; align-items:center;">
                    <input type="email" id="invite-email" placeholder="Enter email address"
                        style="padding:10px; border:1px solid #ddd; border-radius:5px; width:300px;">
                    <button class="btn btn-primary" onclick="inviteAdmin()">Send Invite via Mail</button>
                </div>
                <p style="font-size:12px; color:#888; margin-top:10px;">Note: This will open your default email client
                    with the access details.</p>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // Simple Admin Guard
        if (!sessionStorage.getItem('th_admin')) {
            const pin = prompt('Enter Admin PIN:');
            if (pin === 'admin123' || pin === '123456') {
                sessionStorage.setItem('th_admin', 'true');
            } else {
                alert('Invalid PIN');
                window.location.href = 'index.html';
            }
        }

        function inviteAdmin() {
            const email = document.getElementById('invite-email').value;
            if (!email) {
                alert('Please enter an email address.');
                return;
            }

            const subject = encodeURIComponent("Admin Access Invitation - Top Horizon School");
            const body = encodeURIComponent(`Hello,\n\nYou have been invited to access the Admin Dashboard for Top Horizon School.\n\nAccess Link: ${window.location.href}\nAccess PIN: admin123\n\nPlease keep this credential secure.`);

            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        }


        function logoutAdmin() {
            sessionStorage.removeItem('th_admin');
            window.location.href = 'index.html';
        }

        // --- Logic ---
        function render() {
            // 1. Teachers
            const usersDB = JSON.parse(localStorage.getItem('th_users_db') || '{}');
            const tbody = document.getElementById('teachers-table');
            tbody.innerHTML = '';
            let teacherCount = 0;

            Object.entries(usersDB).forEach(([className, user]) => {
                teacherCount++;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${className}</strong></td>
                    <td style="font-family:monospace; color:#666;">${user.pin}</td>
                    <td>${(user.subjects || []).length} subjects</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${className}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('stat-teachers').textContent = teacherCount;

            // 2. Reports
            let reportCount = 0;
            // Scan keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('th_reports_')) {
                    const data = JSON.parse(localStorage.getItem(key) || '[]');
                    reportCount += data.length;
                }
            }
            document.getElementById('stat-reports').textContent = reportCount;

            // 3. Storage (Approx)
            const total = JSON.stringify(localStorage).length;
            const usage = (total / (5 * 1024 * 1024)) * 100; // Assuming 5MB limit
            document.getElementById('stat-storage').textContent = usage.toFixed(2) + '%';
        }

        function deleteUser(key) {
            if (!confirm(`Delete teacher account for ${key}? This cannot be undone.`)) return;
            const usersDB = JSON.parse(localStorage.getItem('th_users_db') || '{}');
            delete usersDB[key];
            localStorage.setItem('th_users_db', JSON.stringify(usersDB));
            render();
        }

        function backupSystem() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('th_')) {
                    data[key] = localStorage.getItem(key);
                }
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TopHorizon_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }

        function restoreSystem(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('This will OVERWRITE all current data. Continue?')) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.entries(data).forEach(([key, val]) => {
                        localStorage.setItem(key, val);
                    });
                    alert('Restored successfully!');
                    render();
                } catch (err) {
                    alert('Invalid backup file');
                }
            };
            reader.readAsText(file);
        }

        function clearSystem() {
            const code = prompt("Type 'DELETE' to confirm factory reset. ALL DATA WILL BE LOST.");
            if (code === 'DELETE') {
                localStorage.clear();
                alert("System cleared.");
                window.location.reload();
            }
        }

        render();
    </script>
</body>

</html>