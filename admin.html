<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Top Horizon</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-num {
            font-size: 32px;
            font-weight: bold;
            color: var(--theme-orange);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--theme-dark);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="nav-container">
            <div class="brand">
                <i data-lucide="shield" class="brand-icon"></i>
                <span class="brand-name">Top Horizon Admin</span>
            </div>
            <div class="nav-actions">
                <a href="index.html" class="btn btn-secondary" style="text-decoration:none;">Website</a>
                <button class="btn btn-danger" onclick="logoutAdmin()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="admin-container">

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-num" id="stat-teachers">0</div>
                <div>Registered Teachers</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="stat-reports">0</div>
                <div>Total Reports</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="stat-storage">0%</div>
                <div>Storage Usage</div>
            </div>
        </div>

        <!-- Teachers -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="users"></i> Teacher Management
            </h2>
            <p style="color:#666; margin-bottom:15px;">List of all registered classes and teachers.</p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>PIN</th>
                        <th>Subjects</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teachers-table">
                    <!-- JS -->
                </tbody>
            </table>
        </div>

        <!-- Student Database Upload -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="folder-up"></i> Student Database
            </h2>
            <div class="card" style="padding:20px;">
                <p>Upload Excel files (e.g., <code>GRADE_5.xlsx</code>) to populate the student list for each class.
                    <br><strong>Required Columns:</strong> Name, Admission Number, Gender (optional)
                </p>

                <div
                    style="border: 2px dashed #ddd; border-radius: 10px; padding: 30px; text-align: center; margin-top: 20px; position: relative;">
                    <input type="file" id="student-upload" accept=".xlsx, .xls, .csv"
                        style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;"
                        onchange="handleFileUpload(this)">
                    <i data-lucide="upload-cloud" style="width: 48px; height: 48px; color: #ccc;"></i>
                    <p style="margin-top: 10px; color: #666;">Drag & Drop or Click to Upload Excel File</p>
                </div>

                <div id="upload-preview" style="margin-top: 20px; display: none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0;">Preview: <span id="preview-filename"></span></h4>
                        <div>
                            <select id="preview-class-select" style="padding:5px;">
                                <option value="">Select Class...</option>
                                <!-- Populated dynamically -->
                            </select>
                            <button class="btn btn-primary" onclick="saveStudentData()">Save to Database</button>
                            <button class="btn btn-secondary" onclick="cancelUpload()">Cancel</button>
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #eee;">
                        <table class="data-table" style="font-size: 14px;">
                            <thead>
                                <tr id="preview-header">
                                    <!-- Dynamic -->
                                </tr>
                            </thead>
                            <tbody id="preview-body">
                                <!-- Dynamic -->
                            </tbody>
                        </table>
                    </div>
                    <p id="preview-count" style="margin-top:10px; font-size:12px; color:#666;"></p>
                </div>

                <!-- Existing Lists -->
                <div style="margin-top: 30px;">
                    <h4>Stored Classes</h4>
                    <div id="stored-classes-list" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <!-- Badges -->
                    </div>
                </div>
            </div>
        </div>

        <!-- System Data -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="database"></i> System Data
            </h2>
            <div class="card" style="padding:20px;">
                <p>Backup individual data or the entire system database.</p>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn btn-primary" onclick="backupSystem()">Download System Backup (JSON)</button>
                    <input type="file" id="restore-file" style="display:none" onchange="restoreSystem(this)">
                    <button class="btn btn-secondary" onclick="document.getElementById('restore-file').click()">Restore
                        from Backup</button>
                    <button class="btn btn-danger" onclick="clearSystem()">Factory Reset</button>
                </div>
            </div>
        </div>

        <!-- Admin Access Management -->
        <div style="margin-bottom:40px;">
            <h2 style="color:var(--theme-dark); display:flex; align-items:center; gap:10px;">
                <i data-lucide="user-plus"></i> Admin Access
            </h2>
            <div class="card"
                style="padding:20px; background:white; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <p>Invite trusted staff members to become administrators.</p>
                <div style="display:flex; gap:10px; margin-top:15px; align-items:center;">
                    <input type="email" id="invite-email" placeholder="Enter email address"
                        style="padding:10px; border:1px solid #ddd; border-radius:5px; width:300px;">
                    <button class="btn btn-primary" onclick="inviteAdmin()">Send Invite via Mail</button>
                </div>
                <p style="font-size:12px; color:#888; margin-top:10px;">Note: This will open your default email client
                    with the access details.</p>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // Simple Admin Guard
        if (!sessionStorage.getItem('th_admin')) {
            const pin = prompt('Enter Admin PIN (Default: admin123):');
            if (pin === 'admin123' || pin === '123456') {
                sessionStorage.setItem('th_admin', 'true');
            } else {
                alert('Invalid PIN');
                window.location.href = 'index.html';
            }
        }

        function inviteAdmin() {
            const email = document.getElementById('invite-email').value;
            if (!email) {
                alert('Please enter an email address.');
                return;
            }

            const subject = encodeURIComponent("Admin Access Invitation - Top Horizon School");
            const body = encodeURIComponent(`Hello,\n\nYou have been invited to access the Admin Dashboard for Top Horizon School.\n\nAccess Link: ${window.location.href}\nAccess PIN: admin123\n\nPlease keep this credential secure.`);

            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        }


        function logoutAdmin() {
            sessionStorage.removeItem('th_admin');
            window.location.href = 'index.html';
        }

        // --- Logic ---
        function render() {
            // 1. Teachers
            const usersDB = JSON.parse(localStorage.getItem('th_users_db') || '{}');
            const tbody = document.getElementById('teachers-table');
            tbody.innerHTML = '';
            let teacherCount = 0;

            Object.entries(usersDB).forEach(([className, user]) => {
                teacherCount++;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${className}</strong></td>
                    <td style="font-family:monospace; color:#666;">${user.pin}</td>
                    <td>${(user.subjects || []).length} subjects</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${className}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('stat-teachers').textContent = teacherCount;

            // 2. Reports
            let reportCount = 0;
            // Scan keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('th_reports_')) {
                    const data = JSON.parse(localStorage.getItem(key) || '[]');
                    reportCount += data.length;
                }
            }
            document.getElementById('stat-reports').textContent = reportCount;

            // 3. Storage (Approx)
            const total = JSON.stringify(localStorage).length;
            const usage = (total / (5 * 1024 * 1024)) * 100; // Assuming 5MB limit
            document.getElementById('stat-storage').textContent = usage.toFixed(2) + '%';
        }

        function deleteUser(key) {
            if (!confirm(`Delete teacher account for ${key}? This cannot be undone.`)) return;
            const usersDB = JSON.parse(localStorage.getItem('th_users_db') || '{}');
            delete usersDB[key];
            localStorage.setItem('th_users_db', JSON.stringify(usersDB));
            render();
        }

        function backupSystem() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('th_')) {
                    data[key] = localStorage.getItem(key);
                }
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TopHorizon_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }

        function restoreSystem(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('This will OVERWRITE all current data. Continue?')) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.entries(data).forEach(([key, val]) => {
                        localStorage.setItem(key, val);
                    });
                    alert('Restored successfully!');
                    render();
                } catch (err) {
                    alert('Invalid backup file');
                }
            };
            reader.readAsText(file);
        }

        function clearSystem() {
            const code = prompt("Type 'DELETE' to confirm factory reset. ALL DATA WILL BE LOST.");
            if (code === 'DELETE') {
                localStorage.clear();
                alert("System cleared.");
                window.location.reload();
            }
        }

        render();
        renderStoredClasses();

        // --- Student Upload Logic ---
        let currentUploadData = [];

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assume first sheet
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); // Array of Arrays

                if (jsonData.length < 2) {
                    alert('File appears empty or invalid format.');
                    return;
                }

                currentUploadData = jsonData;
                renderPreview(file.name);
            };
            reader.readAsArrayBuffer(file);
        }

        function renderPreview(filename) {
            document.getElementById('upload-preview').style.display = 'block';
            document.getElementById('preview-filename').textContent = filename;

            const headers = currentUploadData[0];
            const rows = currentUploadData.slice(1);

            // Header
            const thead = document.getElementById('preview-header');
            thead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

            // Body (Limit to 5 for preview)
            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = rows.slice(0, 5).map(row => `
                <tr>${row.map(cell => `<td>${cell || ''}</td>`).join('')}</tr>
            `).join('');

            document.getElementById('preview-count').textContent = `Showing 5 of ${rows.length} records`;

            // Auto-detect class from filename
            const classSelect = document.getElementById('preview-class-select');

            // Populate Class Select if empty
            if (classSelect.options.length <= 1) {
                // Common classes
                const defaults = ["PRE-NURSERY", "NURSERY 1", "NURSERY 2", "PRIMARY 1", "PRIMARY 2", "PRIMARY 3", "PRIMARY 4", "PRIMARY 5"];
                defaults.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    classSelect.appendChild(opt);
                });
            }

            // Try to match filename
            const nameUpper = filename.toUpperCase();
            let match = "";
            if (nameUpper.includes("GRADE 5") || nameUpper.includes("PRIMARY 5")) match = "PRIMARY 5";
            else if (nameUpper.includes("GRADE 4") || nameUpper.includes("PRIMARY 4")) match = "PRIMARY 4";
            else if (nameUpper.includes("GRADE 3") || nameUpper.includes("PRIMARY 3")) match = "PRIMARY 3";
            else if (nameUpper.includes("GRADE 2") || nameUpper.includes("PRIMARY 2")) match = "PRIMARY 2";
            else if (nameUpper.includes("GRADE 1") || nameUpper.includes("PRIMARY 1")) match = "PRIMARY 1";
            else if (nameUpper.includes("NURSERY 2")) match = "NURSERY 2";
            else if (nameUpper.includes("NURSERY 1")) match = "NURSERY 1";

            if (match) classSelect.value = match;
        }

        function cancelUpload() {
            document.getElementById('upload-preview').style.display = 'none';
            document.getElementById('student-upload').value = '';
            currentUploadData = [];
        }

        function saveStudentData() {
            const cls = document.getElementById('preview-class-select').value;
            if (!cls) {
                alert("Please select a Class to save this data to.");
                return;
            }

            if (currentUploadData.length < 2) return;

            // Transform to Objects based on headers
            const headers = currentUploadData[0].map(h => h.toString().trim().toLowerCase());
            const rawRows = currentUploadData.slice(1);

            // Identify columns
            let nameIdx = headers.findIndex(h => h.includes('name')); // Strict "name" check first
            if (nameIdx === -1) {
                // Fallback: look for "student" but exclude ID/Number markers
                nameIdx = headers.findIndex(h => h.includes('student') && !h.includes('id') && !h.includes('no') && !h.includes('number') && !h.includes('code'));
            }

            const admIdx = headers.findIndex(h => {
                const lower = h.toLowerCase();
                // Must allow 'adm', 'matric', 'reg'
                // But strictly EXCLUDE 's/n', 'serial', 'no.' (unless it has adm/reg)
                if (lower.includes('s/n') || lower.includes('serial') || lower === 'no' || lower === 'no.') return false;

                return lower.includes('adm') || lower.includes('id') || lower.includes('matric') || lower.includes('reg') || lower.includes('number');
            });

            const sexIdx = headers.findIndex(h => h.includes('sex') || h.includes('gender'));

            if (nameIdx === -1) {
                alert("Could not identify a 'Name' column. Headers found: " + headers.join(', '));
                return;
            }

            const students = rawRows.map(row => {
                return {
                    name: row[nameIdx],
                    admCode: admIdx > -1 ? row[admIdx] : '',
                    sex: sexIdx > -1 ? row[sexIdx] : ''
                };
            }).filter(s => s.name); // Filter empty names

            // Save
            const key = `th_students_${cls}`;
            localStorage.setItem(key, JSON.stringify(students));

            alert(`Successfully saved ${students.length} students to ${cls}.`);
            cancelUpload();
            renderStoredClasses();
        }

        function renderStoredClasses() {
            const container = document.getElementById('stored-classes-list');
            container.innerHTML = '';

            let found = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('th_students_')) {
                    found = true;
                    const cls = key.replace('th_students_', '');
                    const count = JSON.parse(localStorage.getItem(key) || '[]').length;

                    const badge = document.createElement('div');
                    badge.style.cssText = 'background:#eee; padding:5px 10px; border-radius:15px; font-size:12px; display:flex; gap:5px; align-items:center;';
                    badge.innerHTML = `<strong>${cls}</strong> <span>(${count})</span> <span style="cursor:pointer; color:red; margin-left:5px;" onclick="deleteAcc('${key}')">&times;</span>`;
                    container.appendChild(badge);
                }
            }
            if (!found) container.innerHTML = '<span style="color:#999; font-size:12px;">No uploaded data yet.</span>';
        }

        function deleteAcc(key) {
            if (confirm('Delete this student list?')) {
                localStorage.removeItem(key);
                renderStoredClasses();
            }
        }

    </script>
</body>

</html>